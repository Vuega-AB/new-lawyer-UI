<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign in to IntelLaw</title>
    <style>
        /* Your CSS from before - it's perfectly fine to keep it here */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            background: linear-gradient(to bottom right, #000000, #434343, #f5f5f5);
            background-size: cover;
            background-position: center center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }
        .login-container {
            background-color: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.25);
            width: 100%;
            max-width: 380px;
            box-sizing: border-box;
            backdrop-filter: blur(3px);
            -webkit-backdrop-filter: blur(3px);
        }
        .login-header { text-align: center; margin-bottom: 32px; }
        .login-header h1 { font-size: 24px; font-weight: 600; color: #111827; margin: 0; }
        .input-group { margin-bottom: 20px; }
        .input-group label { display: block; margin-bottom: 8px; color: #1f2937; font-size: 14px; font-weight: 500; }
        .input-group input { width: 100%; padding: 12px 16px; border: 1px solid #d1d5db; border-radius: 8px; box-sizing: border-box; font-size: 16px; background-color: #ffffff; color: #111827; }
        .input-group input:focus { outline: none; border-color: #374151; box-shadow: 0 0 0 3px rgba(55, 65, 81, 0.2); }
        .submit-btn { width: 100%; background-color: #111827; color: white; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 500; transition: background-color 0.2s ease-in-out; }
        .submit-btn:hover { background-color: #374151; }
        .footer-text { text-align: center; margin-top: 24px; font-size: 14px; color: #4b5563; }
        .footer-text a { color: #1f2937; text-decoration: none; font-weight: 500; }
        .footer-text a:hover { text-decoration: underline; color: #000000; }
        .error-message { color: #b91c1c; background-color: #fee2e2; border: 1px solid #fca5a5; padding: 10px; border-radius: 6px; text-align: center; margin-bottom: 20px; font-size: 14px; }
    </style>
</head>
<body>
    <div class="login-container">
        <div class="login-header">
            <h1>Sign in to IntelLaw</h1>
        </div>

        <!-- MODIFICATION #1: The Flask/Jinja2 message block was replaced with a single, empty div.
             JavaScript will be responsible for putting error messages here. -->
        <div id="message-container"></div>


        <!-- MODIFICATION #2: The form's 'action' and 'method' were removed.
             We added an 'id' so our JavaScript can easily find this specific form. -->
        <form id="login-form">
            <div class="input-group">
                <label for="email">Email</label>
                <input type="email" id="email" name="email" placeholder="Enter Your Email" required>
            </div>
            <div class="input-group">
                <label for="password">Password</label>
                <input type="password" id="password" name="password" placeholder="Enter Your Password" required>
            </div>
            <button type="submit" class="submit-btn">Sign in</button>
        </form>

        <!-- MODIFICATION #3: Replaced the url_for() with a direct link to the signup file. -->
        <div class="footer-text">
            Don't have an account? <a href="signup.html">Sign up</a>
        </div>

        <!-- MODIFICATION #4: Replaced url_for() with a direct link to the forgot password file.
             Make sure your forgot password file is named 'forgot_password.html'. -->
        <div class="footer-text" style="margin-top: 12px;">
            <a href="forgot_password_request.html">Forgot Password?</a>
        </div>
    </div>

    <!-- MODIFICATION #5: Added script tags to connect this page to our JavaScript logic.
         The order is important: database first, then the authentication logic. -->
    <!-- <script src="../js/auth.js"></script> -->
     <script>
        const API_BASE_URL = "new-lawyer-ui.onrender.com"; //'http://127.0.0.1:5000';

        async function handleLogin(form) {
            console.log("handleLogin function was called!");
            const email = form.querySelector('#email').value;
            const password = form.querySelector('#password').value;
            const messageContainer = document.getElementById('message-container');
            messageContainer.textContent = '';

            try {
                const response = await fetch(`${API_BASE_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password }),
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    const user = result.user;

                    if (user.role === 'admin') {
                        // ---- ADMIN USER FLOW ----
                        console.log("Admin user detected. Bypassing 2FA and logging in directly.");
                        alert("Admin login successful!");

                        // Set the final 'currentUser' key. The main app's auth guard will see this.
                        localStorage.setItem('currentUser', JSON.stringify(user));

                        // Redirect directly to the main application.
                        window.location.href = '../../app/index.html'; // Make sure your main app file is named this
                    } else {
                        // ---- REGULAR USER FLOW ----
                        console.log("Regular user detected. Proceeding to 2FA verification.");

                        // Set the temporary 'user_pending_2fa' key for the 2FA page to use.
                        localStorage.setItem('user_pending_2fa', JSON.stringify(user));

                        // Redirect to the 2FA page.
                        window.location.href = 'login_2fa.html'; // Both login.html and login_2fa.html are in the 'pages' folder.
                    }
                    // =======================================================

                } else {
                    if (result.user_status === 'suspended' || result.user_status === 'pending_activation') {
                        console.log("Account is suspended. Navigating to pending activation page.");
                        
                        sessionStorage.setItem('pending_email', email);
                        
                        window.location.href = 'pending_activation.html';

                    } else if (result.user_status === 'pending_email_confirmation') {
                        console.log("Account requires OTP confirmation. Navigating to OTP page.");
                        sessionStorage.setItem('otp_confirm_email', email);
                        window.location.href = 'confirm_otp_form.html';

                    } else {
                        messageContainer.textContent = result.message || 'Login failed.';
                    }
                }

            } catch (error) {
                // Handle network errors
                console.error("A network error occurred:", error);
                messageContainer.textContent = 'Network Error: Could not connect to the server.';
            }
        }

        // Attach the handleLogin function to the form's submit button
        document.addEventListener('DOMContentLoaded', () => {
            const loginForm = document.getElementById('login-form');
            if (loginForm) {
                loginForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    handleLogin(loginForm);
                });
            }
        });
     </script>

</body>
</html>