<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Confirm Your Email - IntelLaw</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* All of your existing CSS is perfect. No changes needed. */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background: linear-gradient(to bottom right, #000000, #434343, #f5f5f5); background-size: cover; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .container { background-color: #ffffff; padding: 48px 56px; border-radius: 16px; box-shadow: 0 12px 32px rgba(0, 0, 0, 0.1); width: 100%; max-width: 500px; text-align: center; }
        header { display: flex; justify-content: flex-end; margin-bottom: 24px; font-size: 14px; }
        header a { color: #3b82f6; text-decoration: none; font-weight: 500; }
        header a:hover { text-decoration: underline; }
        h1 { font-size: 28px; font-weight: 600; margin-bottom: 12px; color: #111827; }
        .subtitle { font-size: 16px; color: #4b5563; margin-bottom: 16px; }
        .email-display { font-size: 15px; font-weight: 500; color: #1f2937; margin-bottom: 32px; word-break: break-all; }
        .otp-label { display: block; font-size: 16px; font-weight: 500; color: #374151; margin-bottom: 16px; text-align: left; }
        .otp-inputs { display: flex; justify-content: space-between; gap: 12px; margin-bottom: 32px; }
        .otp-inputs input { width: 60px; height: 70px; text-align: center; font-size: 24px; font-weight: 500; border: 2px solid #d1d5db; border-radius: 12px; outline: none; transition: border-color 0.2s, box-shadow 0.2s; box-sizing: border-box; }
        .otp-inputs input:focus { border-color: #3b82f6; box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.2); }
        .otp-inputs input::-webkit-outer-spin-button, .otp-inputs input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .otp-inputs input[type=number] { -moz-appearance: textfield; }
        .continue-btn { width: 100%; padding: 14px; background-color: #1f2937; color: white; border: none; border-radius: 10px; font-size: 18px; font-weight: 500; cursor: pointer; transition: background-color 0.2s; }
        .continue-btn:hover { background-color: #374151; }
        .links-footer { margin-top: 32px; font-size: 15px; color: #4b5563; }
        .links-footer a, .links-footer button.link-style { color: #3b82f6; text-decoration: none; font-weight: 500; background: none; border: none; padding: 0; cursor: pointer; font-size: 15px; } /* Added font-size */
        .links-footer a:hover, .links-footer button.link-style:hover { text-decoration: underline; }
        .flash-message { padding:10px; border-radius:6px; text-align:center; margin-bottom:20px; font-size:14px }
        .flash-message.error { color:#b91c1c; background-color:#fee2e2; border:1px solid #fca5a5 }
        .flash-message.info { color:#1e40af; background-color:#eff6ff; border:1px solid #bfdbfe }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <p>Already have an account? <a href="login.html">Sign in â†’</a></p>
        </header>

        <h1>Confirm your email address</h1>
        <p class="subtitle">We have sent a code to</p>
        <!-- This span is now the placeholder for the email address -->
        <p class="email-display" id="email-display-placeholder">your.email@example.com</p>

        <!-- The flash message container -->
        <div id="message-container"></div>

        <!-- The form now has an ID and no Flask-specific code -->
        <form id="otp-form">
            <label for="otp-1" class="otp-label">Enter code</label>
            <div class="otp-inputs" id="otpInputsContainer">
                <input type="number" name="otp-1" id="otp-1" maxlength="1" required>
                <!-- ... other 5 inputs ... -->
                 <input type="number" name="otp-2" id="otp-2" maxlength="1" required>
                <input type="number" name="otp-3" id="otp-3" maxlength="1" required>
                <input type="number" name="otp-4" id="otp-4" maxlength="1" required>
                <input type="number" name="otp-5" id="otp-5" maxlength="1" required>
                <input type="number" name="otp-6" id="otp-6" maxlength="1" required>
            </div>
            <button type="submit" class="continue-btn">Continue</button>
        </form>

        <div class="links-footer">
            Didn't get your email?
            <!-- This is now a simple button with an ID -->
            <button type="button" id="resend-btn" class="link-style">Resend the code</button>
        </div>
    </div>

<script>
    // --- This script contains ALL logic for the OTP page ---
    const API_BASE_URL = "https://new-lawyer-ui.onrender.com"; //'http://127.0.0.1:5000';

    document.addEventListener('DOMContentLoaded', () => {
        const otpForm = document.getElementById('otp-form');
        const resendBtn = document.getElementById('resend-btn');
        const messageContainer = document.getElementById('message-container');
        const emailDisplay = document.getElementById('email-display-placeholder');
        const otpInputs = Array.from(document.querySelectorAll('#otpInputsContainer input'));

        // --- Step 1: Get the email from sessionStorage and display it ---
        const emailForVerification = sessionStorage.getItem('otp_confirm_email');
        if (!emailForVerification) {
            alert("Session expired. Please start the signup process again.");
            window.location.href = 'signup.html';
            return;
        }
        emailDisplay.textContent = emailForVerification;

        // --- Step 2: Handle the OTP form submission ---
        otpForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            messageContainer.textContent = ''; // Clear old messages

            const otpCode = otpInputs.map(input => input.value).join('');

            if (otpCode.length !== 6) {
                messageContainer.textContent = 'Please enter a 6-digit code.';
                messageContainer.className = 'flash-message error';
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/api/auth/verify-otp`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: emailForVerification, otp_code: otpCode }),
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    // Success! Cleanup and redirect.
                    alert(result.message);
                    sessionStorage.removeItem('otp_confirm_email');
                    window.location.href = 'login.html';
                } else {
                    messageContainer.textContent = result.message; // "Invalid OTP", etc.
                    messageContainer.className = 'flash-message error';
                }
            } catch (error) {
                console.error('OTP verification failed:', error);
                messageContainer.textContent = 'Could not connect to the server.';
                messageContainer.className = 'flash-message error';
            }
        });

        // --- Step 3: Handle the "Resend Code" button click ---
        resendBtn.addEventListener('click', async () => {
            messageContainer.textContent = ''; // Clear old messages

            try {
                const response = await fetch(`${API_BASE_URL}/api/auth/resend-otp`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: emailForVerification }),
                });

                const result = await response.json();
                
                // Show the server's response message (success or failure)
                messageContainer.textContent = result.message;
                messageContainer.className = response.ok ? 'flash-message info' : 'flash-message error';

            } catch (error) {
                console.error('Resend OTP failed:', error);
                messageContainer.textContent = 'Could not connect to the server.';
                messageContainer.className = 'flash-message error';
            }
        });


        // --- Helper script for auto-tabbing between OTP inputs (Your existing script is perfect) ---
        otpInputs.forEach((input, index) => {
            input.addEventListener('input', () => {
                if (input.value.length >= 1 && index < otpInputs.length - 1) {
                    otpInputs[index + 1].focus();
                }
            });
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Backspace' && !input.value && index > 0) {
                    otpInputs[index - 1].focus();
                }
            });
             input.addEventListener('paste', (e) => {
                e.preventDefault();
                const pasteData = (e.clipboardData || window.clipboardData).getData('text').replace(/\D/g, '');
                if (pasteData) {
                    for (let i = 0; i < pasteData.length && (index + i) < otpInputs.length; i++) {
                        otpInputs[index + i].value = pasteData[i];
                    }
                    otpInputs[Math.min(otpInputs.length - 1, index + pasteData.length)].focus();
                }
            });
        });
        if (otpInputs.length > 0) otpInputs[0].focus();
    });
</script>
</body>
</html>